<krpano><!-- AP — default vtour skin: skin events -->

	<!-- 
		Небольшое текстовое окно со скроллом.
	-->
	<scrolltextwindow>
		windowwidth="600"
		windowheight="300"
		windowalign="center"
		window_x="0"
		window_y="0"
		
		text_margin="20"
		scrollslider_width="40"
		
		scrollspeed="3"
		
		viewfov=""
		
	</scrolltextwindow>
	
	<!-- 
		Обработчик прокрутки текста колесом мыши.
	-->
	<data name="onmwheel_handling">	
		mul(wheeldelta, 4);
		add(ny,layer[text].y, wheeldelta); 
		
		sub(th,230,layer[text].pixelheight); 
		
		if(ny GT 0, 
			set(ny,0);
		); 
		if(ny LT th, 
			copy(ny,th);
		); 
		
		div(sy,ny,th); 
		mul(sy,168); 
		add(sy,73); 
		copy(layer[scrollslider].y,sy); 
		copy(layer[text].y,ny); 
		
		set(view.fov, get(scrolltextwindow.viewfov));
	</data>
	
	<data name="lock_fov">
		set(view.fov, get(scrolltextwindow.viewfov));
	</data>
	
	<!-- Здесь будет нормальная функция инициации окна с правильными привязками. -->
	<action name="init_scrolltextwindow">
	
		set(layer[scrolltextwindow].width, get(scrolltextwindow.windowwidth));
		set(layer[scrolltextwindow].height, get(scrolltextwindow.windowheight));
		set(layer[scrolltextwindow].align, get(scrolltextwindow.windowalign));
		set(layer[scrolltextwindow].x, get(scrolltextwindow.window_x));
		set(layer[scrolltextwindow].y, get(scrolltextwindow.window_y));
		
		
		set(layer[text].x, get(scrolltextwindow.text_margin));
		set(layer[text].y, get(scrolltextwindow.text_margin));
		
		sub(layer[text].width, scrolltextwindow.windowwidth, scrolltextwindow.text_margin);
		sub(layer[text].width, scrolltextwindow.scrollslider_width);	
		
	</action>
	
	<!-- 
		Обработчик перетаскивания слайдера.
	-->
	<action name="dragging">
		if(pressed, 					
			sub(dy,mouse.stagey,sy); 
			
			add(ny,cy,dy); 
			
			if(ny LT 73, 
				set(ny,73)
			); 
			if(ny GT 241, 
				set(ny,241)
			); 
			
			copy(y,ny); 
			
			sub(ty,ny,73); 			
			div(ty,168); 
			
			sub(th,230,layer[text].pixelheight);
			
			mul(ty,th); 
			copy(layer[text].y,ty); 

			delayedcall(0,dragging()); 
		);
	</action>
	
	<layer name="scrolltextwindow" 
		type="container" 
		keep="true"
		align="center" 
		x="0" 
		y="0"
		width="600" 
		height="300"
		bgcolor="0x000000"
		bgalpha="0.8"
		visible="false"
		maskchildren="false">
		
		<layer
			name="btn_close"
			url="skin_ap.png" 
			crop="141|409|22|22" 
			ondowncrop="163|409|22|22" 
			align="righttop"
			x="12"
			y="12"
			scale="1.0"
			devices="desktop"
			onclick="
				set(layer[get(parent)].visible, false);
				set(events[skin_events].onviewchange, '');
				set(events[skin_events].onmousewheel, '');
				
				for(set(i, 0), i LT hotspot.count, inc(i),
					set(hotspot[get(i)].enabled, true);
				);
			"
		/>
		
		<layer
			name="btn_close"
			url="skin_ap.png" 
			crop="39|401|39|39" 
			ondowncrop="78|401|39|39" 
			align="righttop"
			x="12"
			y="12"
			scale="0.5"
			devices="tablet"
			
			onloaded="
				if(device.mobile,
					set(scale, 1);
					set(y, -50);
				);
			"
			
			onclick="
				for(set(i, 0), i LT hotspot.count, inc(i),
					set(hotspot[get(i)].enabled, true);
				);
				
				set(layer[get(parent)].visible, false);
				
				set(events[skin_events].onviewchange, '');
				set(events[skin_events].onmousewheel, '');
			"
		/>
		
		<layer name="text_title" 
			url="%SWFPATH%/plugins/textfield.swf" 
			handcursor="false" 
			children="false" 
			align="lefttop" 
			x="20" 
			y="10" 
			width="540" 
			autoheight="true" 
			background="false" 
			border="false" 
			css="text-align:left; color:#ffffff; font-family:OpenSans, sans-serif; font-size:21px; text-indent:14;" 
			html="data:title"
		/>
		
		<!-- Маска текста -->
		<layer name="scrolltextmask" 
			type="container" 
			keep="true"
			align="lefttop" 
			x="20" 
			y="50"
			width="560" 
			height="230"
			visible="true"
			maskchildren="true">
			
			<layer name="text" 
				url="%SWFPATH%/plugins/textfield.swf" 
				handcursor="false" 
				children="false" 
				align="lefttop" 
				x="0" 
				y="0" 
				width="540" 
				autoheight="true" 
				background="false" 
				border="false" 
				css="text-align:left; color:#dddddd; font-family:OpenSans, sans-serif; font-size:16px; leading:8; text-indent:14px; line-height:1.5;" 
				html="data:desc"
				
				onover="
					set(events[skin_events].onmousewheel, get(data[onmwheel_handling].content));
					set(events[skin_events].onviewchange, get(data[lock_fov].content));
				"
				ondown="
					copy(ty,mouse.stagey);
					copy(cy,layer[scrollslider].y);
					dragging1();
				" 
				dragging1="
					if(pressed,
						sub(dy,mouse.stagey,ty);
						add(layer[text].y, dy);
						
						copy(ty,mouse.stagey);
						
						sub(th,230,layer[text].pixelheight); 
						
						if(y LT th,
							copy(y, th);
						);
						if(y GT 0,
							set(y, 0);
						);
						
						div(ny, y, th);
						mul(ny,168);  
						add(ny,73); 
						
						copy(layer[scrollslider].y, ny); 
						delayedcall(0,dragging1()); 
					);
				"
			/>
		</layer>

		<layer name="scrollup" 
			url="skin_ap.png" 
			crop="141|331|22|22" 
			ondowncrop="163|331|22|22" 
			align="righttop" 
			x="33" y="48" 
			zorder="2" 
			rotate="-90"
			devices="desktop"
			ondown="
				asyncloop(pressed, 
					add(ny,layer[text].y, 3); 
					sub(th,230,layer[text].pixelheight); 
					if(ny GT 0, 
						set(ny,0)
					); 
					
					div(sy,ny,th); 
					mul(sy,168); 
					add(sy,73); 
					copy(layer[scrollslider].y,sy); 
					copy(layer[text].y,ny); 
				);
			"
		/>
		
		<layer name="scrollup" 
			url="skin_ap.png" 
			crop="39|323|39|39" 
			ondowncrop="78|323|39|39" 
			scale="0.5"
			align="righttop" 
			x="32" y="48" 
			zorder="2" 
			rotate="-90"
			devices="tablet"
			ondown="
				asyncloop(pressed, 
					add(ny,layer[text].y, 3); 
					sub(th,230,layer[text].pixelheight); 
					if(ny GT 0, 
						set(ny,0)
					); 
					div(sy,ny,th); 
					mul(sy,168); 
					add(sy,73); 
					copy(layer[scrollslider].y,sy); 
					copy(layer[text].y,ny); 
				);
			"
		/>

		<layer name="scrolldown" 
			url="skin_ap.png" 
			crop="141|331|22|22" 
			ondowncrop="163|331|22|22" 
			align="rightbottom" 
			x="33" y="12" 
			zorder="2" 
			rotate="90" 
			devices="desktop"
			ondown="
				asyncloop(pressed, 
					sub(ny,layer[text].y, 3); 
					sub(th,230,layer[text].pixelheight); 
					if(ny LT th, 
						copy(ny,th)
					); 
					div(sy,ny,th); 
					mul(sy,168); 
					add(sy, 73); 
					copy(layer[scrollslider].y,sy); 
					copy(layer[text].y,ny);
				);
			"
		/>
		
		<layer name="scrolldown" 
			url="skin_ap.png" 
			crop="39|323|39|39" 
			ondowncrop="78|323|39|39" 
			scale="0.5"
			align="rightbottom" 
			x="32" y="12" 
			zorder="2" 
			devices="tablet"
			rotate="90" 
			ondown="
				asyncloop(pressed, 
					sub(ny,layer[text].y, 3); 
					sub(th,230,layer[text].pixelheight); 
					if(ny LT th, 
						copy(ny,th)
					); 
					div(sy,ny,th); 
					mul(sy,168); 
					add(sy, 73); 
					copy(layer[scrollslider].y,sy); 
					copy(layer[text].y,ny);
				);
			"
		/>
		
		<layer name="scrollaxis"
			url="skin_ap.png"
			crop="307|0|1|64" 
			align="righttop"
			y="76"
			x="21"
			height="184"
			width="2"
			alpha="0.3"
			enabled="false"
			devices="desktop"
		/>
		
		<layer name="scrollaxis"
			url="skin_ap.png"
			crop="307|0|1|64" 
			align="righttop"
			y="76"
			x="21"
			height="184"
			width="2"
			alpha="0.3"
			enabled="false"
			devices="tablet"
		/>
		
		<layer name="scrollslider" 
			url="skin_ap.png" 
			crop="207|50|22|22"
			ondowncrop="229|50|22|22"
			align="righttop"
			x="11" y="73"
			scale="1"
			devices="desktop"
			zorder="2"
			
			ondown="
				copy(cy,y);
				copy(sy,mouse.stagey);
				dragging();
			" 
		/>	

		<layer name="scrollslider" 
			url="skin_ap.png" 
			crop="224|2|39|39"
			ondowncrop="263|2|39|39"
			scale="0.5"
			align="righttop"
			x="12" y="73"
			devices="tablet"
			zorder="2"
			 
			ondown="
				copy(cy,y);
				copy(sy,mouse.stagey);
				dragging();
			" 
		/>	
		
	</layer>
</krpano>
title: Встраивание виртуального тура на krpano в сайт
-
author: Klaus Reinfeld
-
short-content: Перевод одной из глав документации.
-
content:

Введение
----------

Встраивание плеера krpano в страницу сайта максимально автоматизировано и упрощено до <br />
	• добавления в код страницы одного скрипта и <br />
	• одной строчки кода с параметрами встраивания. <br />

В функции скрипта входит определение типа движка, который будет использоваться(flash или html5) и обработка ограничений по функциональности (они связаны с ОС, браузером и способами ввода)
Как правило, этот скрипт и плеер находятся в одном JS-файле, чаще всего он называется tour.js. В сборке krpano он хранится отдельно в файле embedpano.js.

Функции скрипта embedpano.js
----------

1. Инициация плеера и встраивание его в веб-страницу;
2. Автоматическое определение типа движка (flash или html5);
3. Исправление функциональности колеса мыши, связанное с прокруткой страницы, зуммированием, поддержкой Mac OS, с тачпадом и нормализацией скорости вращения);
4. Исправление ограничений флеш-плеера при использовании непрозрачности и перекрытия слоёв, если [wmode](http://krpano.com/docu/html/#wmode) = transparent/opaque;
5. Подключение возможности перехода в полноэкранный режим для flash;
6. Встраивание своего кода в код плеера виртуального тура.

Встраивание скрипта
----------
Встраивание осуществляетя в любом месте кода веб-страницы один раз так:<br />
	<pre>&#60;script src="embedpano.js"&#62;&#60;/script&#62;</pre><br />
или, когда скрипт совмещён с html5-плеером, так:<br />
	<pre>&#60;script src="tour.js"&#62;&#60;/script&#62;</pre><br />

Встраивание плеера
----------

Для встраивания плеера в нужном месте кода веб-страницы добавляется элемент &#60;div&#62;, которому присваиватся уникальный css-идентификатор и определяется размер с помощью стиля css:<br />
<pre>
&#60;div id="pano" style="width:100%; height:100%;"&#62;<br />
	...<br />
&#60;/div&#62;<br />
</pre>
Внутри этого элемента нужно прописать вызов метода embedpano(), который создаст плеер:
<pre>
&#60;div id="pano" style="width:100%;height:100%;"&#62;
	&#60;noscript&#62;
		&#60;table style="width:100%;height:100%;"&#62;&#60;tr style="valign:middle;"&#62;&#60;td&#62;&#60;div style="text-align:center;"&#62;ERROR:&#60;br/&#62;&#60;br/&#62;Javascript not activated&#60;br/&#62;&#60;br/&#62;&#60;/div&#62;&#60;/td&#62;&#60;/tr&#62;&#60;/table&#62;
	&#60;/noscript&#62;
	&#60;script&#62;
		embedpano({swf:"tour.swf", xml:"tour.xml", target:"pano", html5:"prefer", passQueryParameters:true});
	&#60;/script&#62;
&#60;/div&#62;
</pre>
Функция встраивания в качестве аргумента принимает объект с параметрами встраивания.

Параметры встраивания
----------

Метод embedpano() требует на входе только один объект, через который в произвольном порядке передаются все параметры в виде `parametername:value`.<br />
Все параметры, кроме target, можно опустить, и тогда вместо них будут подставлены значения по умолчанию:

	swf:"krpano.swf"
	
Имя и путь к файлу плеера flash. Значение по умолчанию "krpano.swf", чаще всего вместо него используется "tour.swf"

	js:"krpano.js"

Имя и путь к файлу плеера html5. По умолчанию будет использован параметр swf, в котором расширение будет изменено на .js. Этот параметр игнорируется, когда плеер встроен в скрипт встраивания.

	xml:"krpano.xml"
	
Имя файла с начальной xml-спецификацией и путь к ней. По умолчанию используется то же имя, что и для плееров. Чаще всего вместо него используется "tour.xml".

	target:"...pano-div-id..."

Идентификатор элемента разметки, в который будет встроен плеер. Если параметр не установлен, будет вызвана ошибка "alert()".

	id:"krpanoSWFObject"

Идентификатор внутреннего объекта плеера, который можно использовать для взаимодействия с плеером через [javascript-интерфейс](http://krpano.com/docu/js/). Значение по умолчанию "krpanoSWFObject". Важно помнить, что для каждого экземпляра плеера используется уникальный id. Если объект с данным id уже существует, скрипт встраивания припишет порядковый номер в конце.

	bgcolor:"#000000"

Цвет фона плеера в формате html. По умолчанию чёрный(#000000).

	wmode:"..."

Определение параметра [Window Mode](http://krpano.com/docu/html/#wmode) для флеш-плеера.
Возможные параметры:<br />
	• window — значение по умолчанию, компромисс между возможностями и скоростью работы. Во многих браузерах и системах элементы разметки [не могут перекрывать окно плеера](http://helpx.adobe.com/flash/kb/flash-object-embed-tag-attributes.html#main_Using_Window_Mode__wmode__values_);<br />
	• opaque — разрешить перекрытие окна плеера (работает медленнее);<br />
	• transparent — в добавление к перекрытию позволяет сделать видимыми элементы разметки позади окна плеера(работает ещё медленнее);<br />
	• direct — режим наилучшей производительности, с использованием аппаратного ускорения. Нет возможности перекрытия, ограниченная совместимость со старыми системами и браузерами.<br />

_Примечание для html5: Параметр wmode=transparent будет обработан движком плеера, что позволит сделать его полупрозрачным. Перекрытие окна плеера доступно всегда._

	html5:"auto"

Определяет приоритет использования для движка html5.<br />
	• auto — выбирает html5 только в случае, если не поддерживается flash;<br />
	• prefer — по возможности использовать html5, flash будет использован только если html5 не поддерживается;<br />
	• fallback — режим предпочтения flash, в котором html5 рассматривается как запасной вариант;<br />
	• only — всегда использовать html5. Если он не поддерживается, будет выдана ошибка;<br />
	• always — всегда использовать html5 независимо от наличия поддержки. Используется только для отладки и тестирования;<br />
	• never — не использовать html5.<br />

Также введены расширительные настройки, необходимые для тестирования:<br />
<pre>
• webgl;
• css3d,
</pre>
Они задают технологию рендеринга. Примеры:

	html5="auto+css3d"
	html5="prefer+webgl"
	
По умолчанию выбирается технология WebGL, за исключением случаев:<br />
	• В iOS не доступна, поэтому по умолчанию используется технология css3d;<br />
	• В браузерах для Android, основанных на webview и поддерживающих webgl возможны проблемы с производительностью и рендирингом на разных устройствах, поэтому по умолчанию используется технология css3d;<br />
	• В Android Firefox до версии 22 из-за низкой производительности по умолчанию используется css3d. В версиях 22 и выше по умолчанию используется WebGL.<br />

	vars:{...}

Передаёт объект с параметрами krpano, позволяет установить [начальные параметры krpano](http://krpano.com/docu/html/#startupvars). Также можно установить любые параметры плеера. Параметры будут установлены или перезаписаны после загрузки основного xml и его обработки.

	basepath:...

Базовый путь к swf-файлу, который затем можно использовать для разрешения относительных путей. Может быть использован как во flash, так и в html5 для разрешения относительных путей в xml.

	consolelog:false

Установка определяет, будут ли посылаться сообщения об ошибках плеера в консоль браузера.

	mwheel:true

Определяет порядок использования колеса мыши. В случае установки true, события, вызываемые колесом мыши, будут обработаны в плеере, иначе они будут проигнорированы плеером и обработаны браузером(для прокрутки страницы).

	onready:...Javascript-Function...
	
Позволяет установить вызов функции в момент, когда плеер готов к работе. Вызов осуществляется через [javascript-интерфейс](http://krpano.com/docu/js/), например:

	embedpano({target:"krpanoDIV", onready:krpanoReady});
	function krpanoReady(krpano)
	{
		krpano.call("trace(krpano is ready...)");
	}
	
_Примечание для флеш-плеера. Эта функция требует открытого внешнего интерфейса флеш-плеера (External Interface). При работе оффлайн вызов onready сработает только после изменения настроек безопасности флеш-плеера. [Подробнее](http://krpano.com/docu/localusage/#top)_.

	onerror:...Javascript-Function...

Позволяет использовать произволную функцию-обработчик ошибок. Эта функция будет вызвана с параметром в виде строки с сообщением об ошибке.

	passQueryParameters:false

Когда установлено в true, все параметры из ссылки будут переданы в плеер. Так же все установки из ссылки можно будет передать в html5-плеер. Это делает возможным переключаться между движками flash и html5 с помощью разных ссылок.

Параметры запуска
----------

Существует группа параметров, которые определяют встраивание и не передаются в плеер.

	xml
	
Позволяет задать произвольное имя для стартового файла. Если параметр опущен, в качестве значения по умолчанию будет взято имя swf-файла.

	simulatedevice

Параметр, позволяющий запустить плеер в режиме отладки для разных устройств. Возможные значения:<br />
	• iphone для iPhone, iPod;<br />
	• ipad для всех iPad;<br />
	• useragent — имитация устройства, зависящего от User-Agent;<br />
	• androidmobile — смартфон на Android, только на движке flash;<br />
	• android/androidtablet — планшет на Android.<br />

Для отладки на мобильных устройствах существует специальный симулятор, хранящийся в папке krpano/examples/iphone-ipad-simulator

Прекращение работы плеера
----------

Для удаления экземпляра плеера необходимо использовать функцию removepano(). Эта функция удаляет все настройки мыши, элементы DOM и события HTML5. В качестве параметра функция получает id экземпляра плеера.

	embedpano({target:"panoDIV", id:"pano1"});

	...

	removepano("pano1");
	
Примечания по использованию на мобильных устройствах
----------

Рекомендуются следующие настройки в html:<br />
	• всегда использовать тип документа HTML5: &#60;!DOCTYPE html&#62;;<br />
	• для корректного pixel-perfect отображения любое автоматическое масштабирование страницы и области просмотра должно быть отключено. Это можно сделать с помощью тега &#60;meta&#62; внутри тега &#60;head&#62;:<pre>&#60;meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" /&#62;</pre><br />
	• Не используйте тег &#60;iframe&#62; для встраивания плеера, встраивайте плеер напрямую в страницу. Причина:при использовании iframe невозможно контролировать масштабирование в области вывода, поэтому элементы интерфейса тура отобразятся в неправильном размере.<br />
	
_Примечание: параметр target-densitydpi=device-dpi распознаётся только устройствами на Android, и может вызвать консольные предупреждения в других браузерах(iOS, Chrome(sic!), ...). Это предупреждение можно проигнорировать._

Примеры
----------

1.&#160;Простой пример.
<pre>
	&#60;script&#62; embedpano({target:"pano"}); &#60;/script&#62;
</pre>
Опущены все необязательные параметры, поэтому будут использованы значения по умолчанию: «krpano.swf», «krpano.xml», «krpanoSWFObject» и 100% для размера.

2.&#160;Расширенные настройки для первого примера.
<pre>
	&#60;script&#62;
		embedpano({swf:"pano.swf", xml:"pano.xml", target:"pano"});
	&#60;/script&#62;
</pre>
3.&#160;Настройка приоритетности для движка html5.
<pre>
	&#60;script&#62;
		embedpano({swf:"pano.swf", xml:"pano.xml", target:"pano", html5:"prefer"});
	&#60;/script&#62;
</pre>	
4.&#160;Настройка перекрытия.
<pre>
	&#60;script&#62;
		embedpano({swf:"pano.swf", xml:"pano.xml", target:"pano", wmode:"opaque"});
	&#60;/script&#62;
</pre>	
5.&#160;Выборочное использование html5: предпочитать только на Android и сенсорных устройствах с IE10.
<pre>
	&#60;script&#62;
		function selecthtml5usage()
		{
			// check for Android:
			if( navigator.userAgent.indexOf("Android") &#62;= 0 )
			return "prefer"

			// check for IE10 with multi-touch display:
			if( (navigator.msMaxTouchPoints|0) &#62; 1 )
			return "prefer"

			// for all other cases use html5=auto:
			return "auto";
		}

		embedpano({xml:"pano.xml", target:"pano", html5:selecthtml5usage()});
	&#60;/script&#62;
</pre>	

Источник
----------

Статья основана на переводе [руководства для версии krpano 1.17](http://krpano.com/docu/html) 
title: Виртуальные туры. Часть I. Технические детали
-
author: Алексей Пушкарев
-
short-content: Панорамой можно считать любое изображение, если его соотношение сторон больше 2:1. При этом не имеет значения угол обзора, который охватила камера в момент съёмки или получившийся в результате склейки нескольких изображений в одно.
-
content: # 0. Немного терминов.

Зенит — воображаемая точка в пространстве, обозначающая направление вертикально вверх.
Надир — полная противоположность зенита, эта точка обозначает направление вертикально вниз.


# 1. Что такое панорама?

Панорамой можно считать любое изображение, если его соотношение сторон больше 2:1. При этом не имеет значения угол обзора, который охватила камера в момент съёмки или получившийся в результате склейки нескольких изображений в одно.

Помимо размера и углов обзора панорамы различаются способами проекции, наиболее распространённые из которых

• сферическая. В этом случае всё окружающее пространство проецируется на сферу, а затем строится её развёртка. Итогом такого преобразования становится панорама со сторонами 2:1. Достоинство развёртки сферы — обзор 360° по горизонтали и 180° по вертикали, панорама охватывает всё, что может увидеть человек, стоящий в точке съёмки, и даже то, что у него под подошвами ботинок. :) К недостаткам сферы можно отнести искажения, которые приобретают прямые линии вблизи зенита и надира, изображение в этих местах «размывается» за счёт «растяжения» точек (а зенит и надир вообще растягиваются в прямые линии). В реальной жизни оставлять панораму в такой проекции имеет смысл, если углы обзора по вертикали небольшие, впрочем, искаженные линии могут смотреться очень эффектно — это не то, что человек привык видеть каждый день. Такая проекция наиболее универсальна, из неё можно получить другие проекции;

• цилиндрическая. Изображение проецируется на развёртку цилиндра. В отличие от сферической проекции цилиндрическая меньше искажает вертикальные линии при приближении к зениту и надиру, однако сами крайние точки на проекцию не попадают, поэтому проекции линий при приближении к ним очень растягиваются. Разумной границей вертикального обзора для цилиндрической проекции считается 160°.

• прямоугольная проекция. Изображение в этом случае проецируется на плоскость. Проще всего представить получение такой проекции с помощью окна: чем дальше стоит наблюдатель от проёма, чем уже область за окном, которую он видит, чем ближе наблюдатель, тем шире область. Однако, прямоугольная проекция не может повернуть голову вслед за направлением обзора, поэтому все линии на границе попадают в точку наблюдателя под очень большим углом, что даёт некрасивые искажения вдалеке от центра панорамы. Разумным пределом обзора прямоугольной проекции можно считать 122° по диагонали — такой угол обзора даёт самая широкоугольная оптика со спрямлённым полем.

# 2. Виртуальная панорама

Виртуальная панорама нацелена на взаимодействие с пользователем: за счёт этого мы можем менять угол обзора или способ проекции. Однако при всей вовлечённости зрителя виртуальная панорама остаётся плоским изображением. На данный момент существует единственный способ показать панораму «с объёмом» — анаглиф, в который соединены две панорамы. Так же очень оживляюще действует привязка обзора к гироскопу мобильных устройств. Но и здесь следует оговориться: по личному впечатлению гироскоп работает так, как ожидается, на гаджетах Apple и последних моделях с операционной системой Android.

Так как при создании виртуальной панорамы используется наиболее универсальная сферическая проекция, угол обзора можно назначить любой, который допускает выбранный способ отображения (проекцию или её искажение). Если хочется взглянуть широко, наиболее естественно смотреться будет отображение «рыбий глаз» и, как ни странно, это находит своё отражение в физиологии зрения: чем дальше от оси глаза, тем больше восприятие «сжимает» изображение, это же делает «рыбий глаз» и позволяет охватить одним взглядом пространство в 180° и даже больше.

# 3. Немного математики.

Давайте попробуем разобраться, как можно измерить сферическую панораму; где пределы сужения угла обзора, он же «зум», и как эти две вещи связаны.

Развёртка сферы на плоскость по длинной стороне имеет длину «экватора» сферы — периметра наибольшей окружности, которую можно найти на сфере или пd. По вертикальной стороне на плоскость разворачиваются половинки «меридианов», их длина пd/2. Площадь развёртки будет произведением её сторон — именно эту величину  указывают в качестве размера панорамы, когда говорят «гигапиксель» :) Можно отметить, что эта величина примерно в полтора раза (п/2) больше площади самой сферы.

Виртуальная панорама в своей работе использует развёртку куба, который описан вокруг сферы — 6 прямоугольных проекций. Сторона куба равна диаметру сферы, а площадь 6d^2. Такое представление позволяет наиболее просто отобразить панораму на экране. Кроме того, стороны куба являются конечным этапом подготовки панорамного изображения перед созданием собственно виртуальной панорамы. Таким образом, размер куба, он же диаметр сферы — наиболее информативная величина, которая показывает, сколько информации содержится в панораме.

Предел увеличения панорамы и сужения угла обзора достигается, когда панорама отображается на экране с попиксельной детализацией.

Для своего монитора (по размеру средний, 1600 на 900 точек) я получил такие минимальные углы обзора по диагонали в зависимости от размера куба (в скобках привёл количество мегапикселей в развёртке сферы и приблизительные фокусные расстояния объективов для 35мм плёнки, которые дают такой угол обзора):

2000 (20 мп) — 94° (20 мм)
2800 (39 мп) — 70° (около 30 мм)
4000 (79 мп) — 50° (55 мм)
5600 (154 мп) — 34° (70 мм)
8000 (316 мп) — 26° (100 мм)
11200 (619 мп) — 18° (135 мм)
15700 (1216 мп) — 13° (200 мм)

Тоудоёмкость подготовки изображений растёт пропорционально количеству мегапикселей.

# 4. Как управлять панорамой?

Перед тем, как пойти дальше можно расслабиться на такой мелочи, как управление просмотром. Несмотря на полнофункциональное управление с клавиатуры, удобнее всего вертеть панораму мышкой. Способов управления здесь существует два:

А. «Листание». При таком способе панорама движется в ту сторону, в которую пользователь повёл мышь с зажатой девой кнопкой, при этом панорама приобретает эффект инерции, который можно погасить одиночным кликом. Такое управление наиболее распространено в приложениях для настольных ПК, так как при определённом привыкании становится очень удобным и комфортным. Однако, у этого способа есть два серьёзных недостатка: на слабых компьютерах тормоза убивают эффект и людям, для которых мышь далеко не продолжение руки, очень тяжело подстроиться под такое управление.

Б. «Таскание». При таком способе панорама движется вслед за мышкой. Как тянем, так и едем, инерции нет. Этот способ управления родной для всех устройств с сенсорными экранами, однако в применении к «большим братьям» вполне удобен и при этом лишен недостатков листания.

# 5. Производительность и мобильные возможности.

В целом, виртуальная панорама, собранная любым современным инструментарием, работает достаточно быстро на конфигурациях ПК даже трёх–пятилетней давности. В тестах всё было плохо только на системах с одноядерными процессорами и объёмом оперативной памяти меньше 1 гигабайта. Нередка ситуация, когда открытая вкладка с панорамой, даже неактивная, что–то у себя считает и активно греет процессор: например, если панорама автоматически прокручивается. Эффект рыбьего глаза также требователен к ресурсам. Помимо этого, производительность зависит от наполнения виртуальной экскурсии.

Multiresolution — один из способов отображения виртуальной панорамы на экране. Суть его в том, что стороны куба разбиваются на мозаику небольших изображений, которые подгружаются по мере необходимости. При этом создаются несколько мозаик с разным разрешением от минимального(без зума) до максимального. Такой способ позволяет показывать более детализированные панорамы, чем если бы пользователь смотрел стороны куба целиком. Кроме того, он работает быстрее.

Имеет смысл привести ограничение на размер стороны куба, которую можно показывать без использования технологии multiresolution — 2800 точек, хотя сейчас эта технология используется повсеместно.

Для мобильных устройств приоритетными являются движки на HTML5, хотя старые устройства на android (версии 3.3, например) могут показать и флеш, но скорость работы оставляет желать лучшего. 

С производительностью на планшетах всё хорошо, но идеалом скорости работы будут топовые устройства на android и ipad 2, 3, 4.

# 6. HTML5.

Продолжая тему мобильных возможностей нужно рассказать о движках, использующих эту технологию.

На данный момент возможности движков на связке js+html5+css3 ограничены относительно флеш, например:
• нет поддержки multiresolution, размер стороны куба ограничен 2000 точек;
• ограниченная поддержка видео;
• отсутствие возможности автовоспроизведения на устройствах с iOS.

Управление просмотром, отображение интерфейса практически не отличается от flash, а скорость работы при аналогичном наполнении выше.

# 7. Встраивание панорам в сайт

Виртуальная панорама может быть встроена в любой фрейм сайта (в шапку или на страницу), может автоматически там прокручиваться, ощнако нужно помнить про ограничения производительности и возможностей управления.
-
